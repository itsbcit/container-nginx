FROM bcit/alpine:<%= image.labels['alpine_version'] %>
<%= snippet('labels', binding) -%>

ENV RUNUSER nginx
ENV HOME /var/cache/nginx

RUN printf "%s%s%s\n" \
        "https://nginx.org/packages/alpine/v" \
        "<%= image.labels['alpine_version'] %>" \
        "/main" \
    | tee -a /etc/apk/repositories \
 && wget -O /etc/apk/keys/nginx_signing.rsa.pub https://nginx.org/keys/nginx_signing.rsa.pub \
 && apk add --no-cache \
    nginx=<%= image.labels['nginx_version'] %>-r<%= image.labels['nginx_apk_release'] %> \
    nginx-module-geoip=<%= image.labels['nginx_version'] %>-r<%= image.labels['nginx_apk_release'] %> \
    nginx-module-image-filter=<%= image.labels['nginx_version'] %>-r<%= image.labels['nginx_apk_release'] %> \
    nginx-module-xslt=<%= image.labels['nginx_version'] %>-r<%= image.labels['nginx_apk_release'] %> \
    nginx-module-njs=<%= image.labels['nginx_version'] %>.<%= image.labels['nginx_njs_version'] %>-r<%= image.labels['nginx_apk_release'] %>

RUN chown nginx:root /var/cache/nginx /var/run /var/log/nginx /run \
 && chmod 770 /var/cache/nginx \
 && chmod 775 /var/run /run /var/log/nginx \
 && sed -i "s/user  nginx;/#user  nginx;/" /etc/nginx/nginx.conf \
 && sed -i "s/listen       80;/listen       8080;/" /etc/nginx/conf.d/default.conf \
 #required for 50-copy-nginx-config.sh to copy config files
 && chmod 775 -R /etc/nginx/

COPY 50-copy-nginx-config.sh /docker-entrypoint.d/

RUN touch /usr/share/nginx/html/ping

USER nginx
WORKDIR /application

EXPOSE 8080
ENTRYPOINT ["/tini", "--", "/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
