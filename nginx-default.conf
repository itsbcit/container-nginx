#
# See https://codex.wordpress.org/Nginx
# See https://codex.wordpress.org/Giving_WordPress_Its_Own_Directory
#
# This file is included in https://github.com/nginxinc/docker-nginx/blob/master/stable/alpine/nginx.conf
#

# Upstream to abstract backend connection(s) for php
server {
        listen 8080 default;
        root /application/wp;

        index index.php;

        client_max_body_size 108M;
        charset utf-8;

        #
        # Health check
        #
        location = /ping {
            access_log off;
            allow all;
            return 200 'pong';
        }

        #
        # Restrictions
        #
        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }
        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }
        # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).
        # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
        location ~ /\. {
                deny all;
        }
        # Deny access to any files with a .php extension in the uploads directory
        # Works in sub-directory installs and also in multisite network
        # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
        location ~* /(?:uploads|files)/.*\.php$ {
                deny all;
        }

        #
        # WordPress
        #
        location @rewrites {
                include fastcgi_params;
                include fastcgi.conf;

                rewrite /wp-admin$ $scheme://$host$uri/ permanent;
                rewrite ^ /index.php last;
        }

        location / {
                location ~ [^/]\.php(/|$) {
                        try_files $uri @rewrites;
                        include fastcgi_params;
                        include fastcgi.conf;
                }
                try_files $uri $uri/ @rewrites;
        }

        location /wp-content/ {
                root /application;

                add_header Access-Control-Allow-Origin *;
                add_header Pragma public;
                add_header Cache-Control "public, must-revalidate, proxy-revalidate";
                expires max;

                location ~* \.(?:ico|css|js|gif|jpe?g|png|svg|eot|ttf|woff|mp4|m4v|mov|wmv|avi|mpg|ogv|3gp|3g2|flv|webm|aac|m4a|f4a|mp3|ogg|oga)$ {
                        expires max;
                        try_files $uri =404;
                        # if proxying files from an upstream (e.g., dev, production) server, switch the above for
                        # try_files $uri @images;
                }

                location ~ [^/]\.php(/|$) {
                        try_files $uri @rewrites;
                        include fastcgi_params;
                        include fastcgi.conf;
                }

                try_files $uri $uri/ @rewrites;
        }

}
